version: '3.8'

services:
  selenoid:
    image: aerokube/selenoid:latest
    container_name: selenoid
    ports:
      - "4444:4444"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./browsers.json:/etc/selenoid/browsers.json:ro
    environment:
      - OVERRIDE_VIDEO_OUTPUT_DIR=/opt/selenoid/video
    command: >
      -conf /etc/selenoid/browsers.json
      -limit 5
      -timeout 2m
      -service-startup-timeout 2m
      -container-network brynzaselionidtest_default
    networks:
      - default

  test-runner:
    build: .
    container_name: test-runner
    depends_on:
      - selenoid
    environment:
      - SELENOID_HOST=selenoid
      - SELENOID_PORT=4444
    volumes:
      - ./target:/app/target
      - ./allure-results:/app/allure-results
    networks:
      - default
    command: >
      sh -c "
        echo 'Ожидание запуска Selenoid...' &&
        sleep 10 &&
        echo 'Проверка Selenoid...' &&
        curl -s http://selenoid:4444/status || echo 'Selenoid не доступен' &&
        echo '' &&
        mvn test -Dselenium.host=selenoid -Dselenium.port=4444
      "